!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("ws")):"function"==typeof define&&define.amd?define(["ws"],n):(e="undefined"!=typeof globalThis?globalThis:e||self).GPUjsHiveCompute=n(e.ws)}(this,(function(e){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=n(e),r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function o(e,n,t){return e(t={path:n,exports:{},require:function(e,n){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==n&&t.path)}},t.exports),t.exports}var i=o((function(e,n){Object.defineProperty(n,"__esModule",{value:!0}),n.ASK_ACTIONS=n.TELL_ACTIONS=n.COMM_TYPE=void 0,function(e){e.ASK="ask",e.TELL="tell",e.REQUEST_CONN="request_conn"}(n.COMM_TYPE||(n.COMM_TYPE={})),function(e){e.KERNEL_BUILT="kernel_built",e.KERNEL_RUN_DONE="kernel_run_done",e.CONN_ACCEPTED="conn_accepted"}(n.TELL_ACTIONS||(n.TELL_ACTIONS={})),function(e){e[e.BUILD_KERNEL=0]="BUILD_KERNEL",e[e.RUN_KERNEL=1]="RUN_KERNEL"}(n.ASK_ACTIONS||(n.ASK_ACTIONS={}))})),a=o((function(e,n){function t(e,n){return e.send(JSON.stringify({type:i.COMM_TYPE.TELL,data:n})),e}Object.defineProperty(n,"__esModule",{value:!0}),n.onDisconnect=n.onConnect=n.onTell=n.onAsk=n.tell=n.ask=void 0,n.ask=function(e,n){return e.send(JSON.stringify({type:i.COMM_TYPE.ASK,data:n})),e},n.tell=t,n.onAsk=function(e,n,r){return e.on("message",(function(o){var a=JSON.parse(o);t(e,{action:i.TELL_ACTIONS.CONN_ACCEPTED}),a.type==i.COMM_TYPE.ASK&&a.data.action==n&&r(a.data)})),e},n.onTell=function(e,n,t){return e.on("message",(function(e){var r=JSON.parse(e);r.type==i.COMM_TYPE.TELL&&r.data.action==n&&t(r.data)})),e},n.onConnect=function(e,n){return e.on("message",(function(t){JSON.parse(t).type==i.COMM_TYPE.REQUEST_CONN&&n(e)})),e},n.onDisconnect=function(e,n){return e.on("close",n),e}})),u=o((function(e,n){var t=r&&r.__awaiter||function(e,n,t,r){return new(t||(t=Promise))((function(o,i){function a(e){try{l(r.next(e))}catch(e){i(e)}}function u(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,u)}l((r=r.apply(e,n||[])).next())}))},o=r&&r.__generator||function(e,n){var t,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=n.call(e,a)}catch(e){i=[6,e],r=0}finally{t=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}};Object.defineProperty(n,"__esModule",{value:!0}),n.runHelper=void 0,n.runHelper=function(e,n,r,u){return void 0===u&&(u=console.log),t(this,void 0,void 0,(function(){return o(this,(function(t){return[2,new Promise((function(t,o){var l,s=new e(r);s.on("open",(function(){u("Connecting as helper."),s.send(JSON.stringify({type:i.COMM_TYPE.REQUEST_CONN,data:{}})),a.onTell(s,i.TELL_ACTIONS.CONN_ACCEPTED,(function(){return u("Connection accepted.")}))})),s.on("error",(function(){o(new Error("WebSocket error."))})),s.on("close",(function(){u("Connection closed."),t()})),a.onAsk(s,i.ASK_ACTIONS.BUILD_KERNEL,(function(e){u("Building kernel."),l=n.createKernel(e.extras.kernelFunc,e.extras.kernelOptions),u("Kernel built."),a.tell(s,{action:i.TELL_ACTIONS.KERNEL_BUILT})})),a.onAsk(s,i.ASK_ACTIONS.RUN_KERNEL,(function(e){var n;u("Running kernel."),n=e.extras.inputsLength>0?l.apply(void 0,e.extras.inputs):l(),u("Output generated, transmitting."),a.tell(s,{action:i.TELL_ACTIONS.KERNEL_RUN_DONE,extras:{output:n}})}))}))]}))}))}})),l=o((function(e,n){var o=r&&r.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e}).apply(this,arguments)},i=r&&r.__awaiter||function(e,n,t,r){return new(t||(t=Promise))((function(o,i){function a(e){try{l(r.next(e))}catch(e){i(e)}}function u(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,u)}l((r=r.apply(e,n||[])).next())}))},a=r&&r.__generator||function(e,n){var t,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=n.call(e,a)}catch(e){i=[6,e],r=0}finally{t=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},l=r&&r.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.hiveHelp=n.hiveHelpDefaults=void 0;var s=l(t.default);n.hiveHelpDefaults={logFunction:console.log},n.hiveHelp=function(e){return i(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return e=o(o({},n.hiveHelpDefaults),e),[4,u.runHelper(s.default,e.gpu,e.url,e.logFunction)];case 1:return[2,t.sent()]}}))}))}}));const{runHelper:s}=u,{hiveHelpDefaults:c}=l;class f extends WebSocket{openHandlers=[];errHandlers=[];messageHandlers=[];closeHandlers=[];constructor(...e){super(...e),this.onopen=({data:e})=>{this.openHandlers.forEach(n=>n(e))},this.onerror=({data:e})=>{this.errHandlers.forEach(n=>n(e))},this.onmessage=({data:e})=>{this.messageHandlers.forEach(n=>n(e))},this.onclose=({data:e})=>{this.closeHandlers.forEach(n=>n(e))}}on(e,n){switch(e){case"open":this.openHandlers.push(n);break;case"error":this.errHandlers.push(n);break;case"message":this.messageHandlers.push(n);break;case"close":this.closeHandlers.push(n)}}}return{hiveHelp:async function(e){e={hiveHelpDefaults:c,...e};const{gpu:n,url:t,logFunction:r}=e;return await s(f,n,t,r)}}}));
